---
title: "Untitled"
author: "Emma Morgan"
date: "March 1, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Testing using our IPEDS compile function to view output...

```{r load_functions}

#Sample script to compile vartable and valuesets longitudinal files

#First load in all scripts; this can be cleaned up!
#####merge_IPEDS_data_NEW######################
script_peerList <- RCurl::getURL("https://raw.githubusercontent.com/emmamorgan-tufts/IPEDS_longitudinal/develop_em/peerList.R", ssl.verifypeer = FALSE)
script_filename_to_tablename <- RCurl::getURL("https://raw.githubusercontent.com/emmamorgan-tufts/IPEDS_longitudinal/master/filename_to_tablename.R", ssl.verifypeer = FALSE)
script_add_valuesets <- RCurl::getURL("https://raw.githubusercontent.com/emmamorgan-tufts/IPEDS_longitudinal/master/add_valuesets.R", ssl.verifypeer = FALSE)
script_varnames_to_titles <- RCurl::getURL("https://raw.githubusercontent.com/emmamorgan-tufts/IPEDS_longitudinal/master/change_varnames_to_vartitles.R", ssl.verifypeer = FALSE)
script_acadyear <- RCurl::getURL("https://raw.githubusercontent.com/emmamorgan-tufts/IPEDS_longitudinal/master/acad_yr_function.R", ssl.verifypeer = FALSE)
script_lookup_helper <- RCurl::getURL("https://raw.githubusercontent.com/emmamorgan-tufts/IPEDS_longitudinal/develop_em/lookup_helper.R", ssl.verifypeer = FALSE)
script_read_clean_data <- RCurl::getURL("https://raw.githubusercontent.com/emmamorgan-tufts/IPEDS_longitudinal/develop_em/read_clean_data.R", ssl.verifypeer = FALSE)
script_merge_IPEDS_data <- RCurl::getURL("https://raw.githubusercontent.com/emmamorgan-tufts/IPEDS_longitudinal/develop_em/merge_ipeds_data.R", ssl.verifypeer = FALSE)

eval(parse(text = script_peerList))
eval(parse(text = script_filename_to_tablename))
eval(parse(text = script_add_valuesets))
eval(parse(text = script_varnames_to_titles))
eval(parse(text = script_acadyear))
eval(parse(text = script_lookup_helper))
eval(parse(text = script_read_clean_data))
eval(parse(text = script_merge_IPEDS_data))

rm("pkg","pkgs", "script_add_valuesets", "script_lookup_helper", "script_merge_IPEDS_data", "script_peerList",
   "script_read_clean_data","script_varnames_to_titles")
```

Once the functions are loaded, we want to read in our peer file.

```{r load_peers}
#Tufts standard peers TEST
  peer_filepath <- "Q:\\Staff\\University-Wide\\Peer Comparison Database\\IPEDS\\UndergradPeers_IDandNames.csv"
  IPEDS_peers <- IPEDS_peers_from_file(peer_filepath)
  peer_UNITIDs <- IPEDS_peers$peers_for_IPEDS


```

Now I want to try iterating through each of the surveys. I can do this by reading in a list of the surveys from the IPEDS folder.

```{r surveylist}

all_IPEDS_folders <- list.files(path="Q:\\Staff\\University-Wide\\Peer Comparison Database\\IPEDS\\Original IPEDS Data")

```

Now iterate through each survey

```{r test_surveys}

IPEDS_data_location_general <- "Q:\\Staff\\University-Wide\\Peer Comparison Database\\IPEDS\\Original IPEDS Data"

for (i in all_IPEDS_folders) {
  
  print(paste("Survey:", i))
  
  surveyFolder <- i
  IPEDS_data_location <- paste(IPEDS_data_location_general,surveyFolder, sep="\\")
  IPEDS_test <- tryCatch(merge_IPEDS_data_NEW(IPEDS_data_location, peer_UNITIDs),
                         error = function(e) {
                           print(paste("Survey error:", surveyFolder))
                           next(i)
                         })
  IPEDS_data <- IPEDS_test$data
  IPEDS_dictionary <- IPEDS_test$dictionary
  IPEDS_valueset <- IPEDS_test$valuesets
  
  if (is.null(IPEDS_data)) {
    print("No data for peer group. Moving on to next survey")
    next(i)
  }
  
  #We have integrated peer subsetting into IPEDS_merge_data
  data_add_valuesets <- add_values(longtable=IPEDS_data, valueset = IPEDS_valueset, ignore_size_warning = T)
  data_add_vartitles <- change_varnames_vartitles(longtable=data_add_valuesets, varnames=IPEDS_dictionary, ignore_size_warning = T)
  
  #Add Institution Names
  data_final <- dplyr::left_join(data_add_vartitles, IPEDS_peers$peerdf,"UNITID","INSTITUTION.NAME")
  head(data_final)
}


```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.


When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
